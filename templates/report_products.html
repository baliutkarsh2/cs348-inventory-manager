{% extends 'base.html' %}
{% block content %}
<h2 class="mb-3"><i class="fa-solid fa-chart-line me-2"></i>Products Report</h2>
<form class="row g-3 mb-4" method="get">
  <div class="col-md-3">
    <label class="form-label">Category</label>
    <select class="form-select" name="category_id">
      <option value="">All</option>
      {% for c in categories %}
      <option value="{{ c.id }}" {% if request.args.get('category_id')|int == c.id %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Supplier</label>
    <select class="form-select" name="supplier_id">
      <option value="">All</option>
      {% for s in suppliers %}
      <option value="{{ s.id }}" {% if request.args.get('supplier_id')|int == s.id %}selected{% endif %}>{{ s.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Min Price</label>
    <input type="number" step="0.01" min="0" name="min_price" class="form-control" value="{{ request.args.get('min_price','') }}" />
  </div>
  <div class="col-md-3">
    <label class="form-label">Max Price</label>
    <input type="number" step="0.01" min="0" name="max_price" class="form-control" value="{{ request.args.get('max_price','') }}" />
  </div>
  <div class="col-md-3">
    <label class="form-label">Min Stock</label>
    <input type="number" step="1" min="0" name="min_stock" class="form-control" value="{{ request.args.get('min_stock','') }}" />
  </div>
  <div class="col-md-3">
    <label class="form-label">Max Stock</label>
    <input type="number" step="1" min="0" name="max_stock" class="form-control" value="{{ request.args.get('max_stock','') }}" />
  </div>
  <div class="col-12">
    <button class="btn btn-primary" type="submit">Filter</button>
  </div>
</form>

<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-secondary text-uppercase small">Avg Price</div>
        <div class="fs-4 fw-bold">${{ '%.2f'|format(avg_price) }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-secondary text-uppercase small">Avg Stock</div>
        <div class="fs-4 fw-bold">{{ '%.1f'|format(avg_stock) }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-secondary text-uppercase small">Total Inventory Value</div>
        <div class="fs-4 fw-bold">${{ '%.2f'|format(total_value) }}</div>
      </div>
    </div>
  </div>
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <canvas id="reportChart" height="80"></canvas>
      </div>
    </div>
  </div>
</div>

<table class="table table-bordered table-sm align-middle">
  <thead>
    <tr>
      <th>Name</th>
      <th>SKU</th>
      <th>Category</th>
      <th>Supplier</th>
      <th>Price</th>
      <th>Stock</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
  {% for p in results %}
    <tr>
      <td>{{ p.name }}</td>
      <td>{{ p.sku }}</td>
      <td>{{ p.category.name }}</td>
      <td>{{ p.supplier.name }}</td>
      <td>${{ '%.2f'|format(p.price) }}</td>
      <td>{{ p.units_in_stock }}</td>
      <td>${{ '%.2f'|format(p.price * p.units_in_stock) }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% if results|length == 0 %}
<div class="alert alert-info">No products match your filters.</div>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('reportChart');
    if (!ctx) return;
    const labels = JSON.parse('{{ labels_json|tojson|safe }}');
    const prices = JSON.parse('{{ prices_json|tojson|safe }}');
    const stocks = JSON.parse('{{ stocks_json|tojson|safe }}');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Price', data: prices, backgroundColor: 'rgba(54, 162, 235, 0.5)' },
          { label: 'Stock', data: stocks, backgroundColor: 'rgba(75, 192, 192, 0.5)' }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });
  });
</script>
{% endblock %}
